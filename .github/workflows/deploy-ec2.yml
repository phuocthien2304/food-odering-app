name: Deploy to AWS EC2 (Docker Compose)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.aws.yml'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-ec2.yml'
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch, tag, or SHA). Default: main"
        required: false
        default: "main"

concurrency:
  group: deploy-ec2-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_REF: ${{ github.event.inputs.ref || github.ref_name }}
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || '22' }}
          script: |
            set -e

            APP_DIR="${{ secrets.EC2_APP_DIR }}"
            if [ -z "$APP_DIR" ]; then
              echo "EC2_APP_DIR secret is required (e.g. /home/ubuntu/food-odering-app)"
              exit 1
            fi

            cd "$APP_DIR"

            git fetch --all --prune

            git checkout "${DEPLOY_REF}"
            git pull

            docker compose -f docker-compose.aws.yml up -d --build
            docker image prune -f
