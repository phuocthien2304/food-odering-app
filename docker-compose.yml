version: '3.8'

services:
  # =========================================
  # 1. API GATEWAY
  # =========================================
  api-gateway:
    build:
      context: ./backend/api-gateway  # <--- Đường dẫn chuẩn từ Root  
      dockerfile: Dockerfile
    container_name: food-ordering-api-gateway
    ports:
      - "3000:3000"
    environment:
      GATEWAY_PORT: 3000
      # Cloud config
      RABBITMQ_URI: ${RABBITMQ_URI}
      MONGODB_URI: ${MONGODB_URI_API_GATEWAY}
      
      # Internal URLs
      USER_SERVICE_URL: http://user-service:3003
      ORDER_SERVICE_URL: http://order-service:3001
      RESTAURANT_SERVICE_URL: http://restaurant-service:3002
      DELIVERY_SERVICE_URL: http://delivery-service:3004
      PAYMENT_SERVICE_URL: http://payment-service:3005
      FRONTEND_URL: ${FRONTEND_URL}
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped
    volumes:
      - ./backend/api-gateway:/app
      - /app/node_modules
    command: sh -c "npm install && npm run build && npm start"
  # =========================================
  # 2. FRONTEND
  # =========================================
  frontend:
    build:
      context: ./frontend  # <--- Đường dẫn chuẩn từ Root
      dockerfile: Dockerfile
      args:
        VITE_API_GATEWAY_URL: ${VITE_API_GATEWAY_URL:-http://localhost:3000/api}
    container_name: food-ordering-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend/src:/app/src
      - /app/node_modules
    depends_on:
      - api-gateway
    networks:
      - food-ordering-network
    restart: unless-stopped

  # =========================================
  # 3. USER SERVICE
  # =========================================
  user-service:
    build:
      context: ./backend/user-service  # <--- Đường dẫn chuẩn từ Root
      dockerfile: Dockerfile
    container_name: food-ordering-user-service
    ports:
      - "3003:3003"
    environment:
      USER_SERVICE_PORT: 3003
      MONGODB_URI: ${MONGODB_URI_USER_SERVICE}
      RABBITMQ_URI: ${RABBITMQ_URI}
      JWT_SECRET: ${JWT_SECRET}
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped
    volumes:
      - ./backend/user-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run build && npm start"
  # =========================================
  # 4. ORDER SERVICE
  # =========================================
  order-service:
    build:
      context: ./backend/order-service
      dockerfile: Dockerfile
    container_name: food-ordering-order-service
    ports:
      - "3001:3001"
    environment:
      ORDER_SERVICE_PORT: 3001
      MONGODB_URI: ${MONGODB_URI_ORDER_SERVICE}
      RABBITMQ_URI: ${RABBITMQ_URI}
      ORDER_QUEUE: order_queue
      PAYMENT_QUEUE: payment_queue
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped
    volumes:
      - ./backend/order-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run build && npm start"
  # =========================================
  # 5. RESTAURANT SERVICE
  # =========================================
  restaurant-service:
    build:
      context: ./backend/restaurant-service
      dockerfile: Dockerfile
    container_name: food-ordering-restaurant-service
    ports:
      - "3002:3002"
    environment:
      RESTAURANT_SERVICE_PORT: 3002
      MONGODB_URI: ${MONGODB_URI_RESTAURANT_SERVICE}
      RABBITMQ_URI: ${RABBITMQ_URI}
      RESTAURANT_QUEUE: restaurant_queue
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped
    volumes:
      - ./backend/restaurant-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run build && npm start"

  # =========================================
  # 6. DELIVERY SERVICE
  # =========================================
  delivery-service:
    build:
      context: ./backend/delivery-service
      dockerfile: Dockerfile
    container_name: food-ordering-delivery-service
    ports:
      - "3004:3004"
    environment:
      DELIVERY_SERVICE_PORT: 3004
      MONGODB_URI: ${MONGODB_URI_DELIVERY_SERVICE}
      RABBITMQ_URI: ${RABBITMQ_URI}
      DELIVERY_QUEUE: delivery_queue
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped
    volumes:
      - ./backend/delivery-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run build && npm start"
  # =========================================
  # 7. PAYMENT SERVICE
  # =========================================
  payment-service:
    build:
      context: ./backend/payment-service
      dockerfile: Dockerfile
    container_name: food-ordering-payment-service
    ports:
      - "3005:3005"
    environment:
      PAYMENT_SERVICE_PORT: 3005
      MONGODB_URI: ${MONGODB_URI_PAYMENT_SERVICE}
      RABBITMQ_URI: ${RABBITMQ_URI}
      PAYMENT_QUEUE: payment_queue
      ORDER_QUEUE: order_queue
      SEPAY_ACCOUNT_ID: ${SEPAY_ACCOUNT_ID}
      SEPAY_API_KEY: ${SEPAY_API_KEY}
      SEPAY_API_SECRET: ${SEPAY_API_SECRET}
      SEPAY_ACCOUNT_NUMBER: ${SEPAY_ACCOUNT_NUMBER}
      SEPAY_BANK_NAME: ${SEPAY_BANK_NAME}
      SEPAY_BANK_CODE: ${SEPAY_BANK_CODE}
      PAYMENT_CALLBACK_URL: ${PAYMENT_CALLBACK_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped
    volumes:
      - ./backend/payment-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run build && npm start" 

networks:
  food-ordering-network:
    driver: bridge
