version: '3.8'

services:
  # =========================================
  # 1. API GATEWAY
  # =========================================
  api-gateway:
    build:
      context: ./backend/api-gateway  # <--- Đường dẫn chuẩn từ Root
      dockerfile: Dockerfile
    container_name: food-ordering-api-gateway
    ports:
      - "3000:3000"
    environment:
      GATEWAY_PORT: 3000
      # Cloud config
      RABBITMQ_URI: amqps://apvwrzfk:fIsArbh3Y8j8bfed_eZa9KO1oIcDhdil@armadillo.rmq.cloudamqp.com/apvwrzfk
      MONGODB_URI: mongodb+srv://phuocthien2304:phuocthien2304@cluster0.zpki9d4.mongodb.net/api-gateway?retryWrites=true&w=majority&appName=Cluster0
      
      # Internal URLs
      USER_SERVICE_URL: http://user-service:3003
      ORDER_SERVICE_URL: http://order-service:3001
      RESTAURANT_SERVICE_URL: http://restaurant-service:3002
      DELIVERY_SERVICE_URL: http://delivery-service:3004
      PAYMENT_SERVICE_URL: http://payment-service:3005
      FRONTEND_URL: http://localhost:5173
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped

  # =========================================
  # 2. FRONTEND
  # =========================================
  frontend:
    build:
      context: ./frontend  # <--- Đường dẫn chuẩn từ Root
      dockerfile: Dockerfile
    container_name: food-ordering-frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://api-gateway:3000/api
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - api-gateway
    networks:
      - food-ordering-network
    restart: unless-stopped

  # =========================================
  # 3. USER SERVICE
  # =========================================
  user-service:
    build:
      context: ./backend/user-service  # <--- Đường dẫn chuẩn từ Root
      dockerfile: Dockerfile
    container_name: food-ordering-user-service
    ports:
      - "3003:3003"
    environment:
      USER_SERVICE_PORT: 3003
      MONGODB_URI: mongodb+srv://phuocthien2304:phuocthien2304@cluster0.zpki9d4.mongodb.net/user-service?retryWrites=true&w=majority&appName=Cluster0
      RABBITMQ_URI: amqps://apvwrzfk:fIsArbh3Y8j8bfed_eZa9KO1oIcDhdil@armadillo.rmq.cloudamqp.com/apvwrzfk
      JWT_SECRET: your-jwt-secret-key-change-in-production
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped

  # =========================================
  # 4. ORDER SERVICE
  # =========================================
  order-service:
    build:
      context: ./backend/order-service
      dockerfile: Dockerfile
    container_name: food-ordering-order-service
    ports:
      - "3001:3001"
    environment:
      ORDER_SERVICE_PORT: 3001
      MONGODB_URI: mongodb+srv://phuocthien2304:phuocthien2304@cluster0.zpki9d4.mongodb.net/order-service?retryWrites=true&w=majority&appName=Cluster0
      RABBITMQ_URI: amqps://apvwrzfk:fIsArbh3Y8j8bfed_eZa9KO1oIcDhdil@armadillo.rmq.cloudamqp.com/apvwrzfk
      ORDER_QUEUE: order_queue
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped

  # =========================================
  # 5. RESTAURANT SERVICE
  # =========================================
  restaurant-service:
    build:
      context: ./backend/restaurant-service
      dockerfile: Dockerfile
    container_name: food-ordering-restaurant-service
    ports:
      - "3002:3002"
    environment:
      RESTAURANT_SERVICE_PORT: 3002
      MONGODB_URI: mongodb+srv://phuocthien2304:phuocthien2304@cluster0.zpki9d4.mongodb.net/restaurant-service?retryWrites=true&w=majority&appName=Cluster0
      RABBITMQ_URI: amqps://apvwrzfk:fIsArbh3Y8j8bfed_eZa9KO1oIcDhdil@armadillo.rmq.cloudamqp.com/apvwrzfk
      RESTAURANT_QUEUE: restaurant_queue
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped

  # =========================================
  # 6. DELIVERY SERVICE
  # =========================================
  delivery-service:
    build:
      context: ./backend/delivery-service
      dockerfile: Dockerfile
    container_name: food-ordering-delivery-service
    ports:
      - "3004:3004"
    environment:
      DELIVERY_SERVICE_PORT: 3004
      MONGODB_URI: mongodb+srv://phuocthien2304:phuocthien2304@cluster0.zpki9d4.mongodb.net/delivery-service?retryWrites=true&w=majority&appName=Cluster0
      RABBITMQ_URI: amqps://apvwrzfk:fIsArbh3Y8j8bfed_eZa9KO1oIcDhdil@armadillo.rmq.cloudamqp.com/apvwrzfk
      DELIVERY_QUEUE: delivery_queue
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped

  # =========================================
  # 7. PAYMENT SERVICE
  # =========================================
  payment-service:
    build:
      context: ./backend/payment-service
      dockerfile: Dockerfile
    container_name: food-ordering-payment-service
    ports:
      - "3005:3005"
    environment:
      PAYMENT_SERVICE_PORT: 3005
      MONGODB_URI: mongodb+srv://phuocthien2304:phuocthien2304@cluster0.zpki9d4.mongodb.net/payment-service?retryWrites=true&w=majority&appName=Cluster0
      RABBITMQ_URI: amqps://apvwrzfk:fIsArbh3Y8j8bfed_eZa9KO1oIcDhdil@armadillo.rmq.cloudamqp.com/apvwrzfk
      PAYMENT_QUEUE: payment_queue
      VNPAY_GATEWAY_URL: https://sandbox.vnpayment.vn/paygate
      VNPAY_SECRET_KEY: SHOWCASESECRETKEY12345678
      SEPAY_GATEWAY_URL: https://sepay.vn
      PAYMENT_CALLBACK_URL: http://api-gateway:3000/api
      FRONTEND_URL: http://localhost:5173
      NODE_ENV: development
    networks:
      - food-ordering-network
    restart: unless-stopped

networks:
  food-ordering-network:
    driver: bridge
